-----------------------------------------------------------------------------------------------------------------------------------------
-- CONNECTION
-----------------------------------------------------------------------------------------------------------------------------------------
local Creative = {}
Tunnel.bindInterface("deliver",Creative)
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIABLES
-----------------------------------------------------------------------------------------------------------------------------------------
local Blip = nil
local Locate = ""
local Selected = 1
local Starting = false
-----------------------------------------------------------------------------------------------------------------------------------------
-- INITLIST
-----------------------------------------------------------------------------------------------------------------------------------------
local initList = {
	["BurgerShot"] = { -1196.53,-904.57,13.93,1.0,1.0,"Trabalhar",false },
	["PizzaThis"] = { 806.89,-745.59,26.77,0.5,1.0,"Trabalhar",false },
	["UwuCoffee"] = { -594.0,-1052.47,22.34,0.5,1.0,"Trabalhar",false },
	["Lumberman"] = { 2433.45,5013.46,46.99,0.5,1.0,"Trabalhar",false },
	["Drugsmansouth"] = { 2433.45,5013.46,46.99,0.5,1.0,"Trabalhar",true },
	["Drugsmannorth"] = { 2433.45,5013.46,46.99,0.5,1.0,"Trabalhar",true }
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- THREADSTART
-----------------------------------------------------------------------------------------------------------------------------------------
CreateThread(function()
	for k,v in pairs(initList) do
		exports["target"]:AddCircleZone("Deliver:"..k,vec3(v[1],v[2],v[3]),v[4],{
			name = "Deliver:"..k,
			heading = 3374176
		},{
			shop = k,
			Distance = v[5],
			options = {
				{
					event = "deliver:Starting",
					tunnel = "shop",
					label = v[6]
				}
			}
		})
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- CDS
-----------------------------------------------------------------------------------------------------------------------------------------
local Cds = {
	["BurgerShot"] = {
		{ -30.67,-346.94,46.52 },
		{ -197.36,-831.38,30.75 },
		{ -284.41,-600.6,33.55 },
		{ -287.26,-1060.19,27.2 },
		{ -170.71,-1449.71,31.64 },
		{ 87.57,-1670.53,29.18 },
		{ 218.1,-1838.83,27.33 },
		{ 379.52,-1781.49,29.47 },
		{ 561.39,-1751.82,29.28 },
		{ 431.69,-2035.13,23.32 },
		{ -421.75,-2171.55,11.34 },
		{ -621.03,-1639.95,26.35 },
		{ -697.59,-1182.27,10.72 },
		{ -1031.3,-902.98,3.69 },
		{ -1499.69,-933.09,10.18 },
		{ -1918.69,-542.63,11.83 },
		{ -1681.23,-290.87,51.88 },
		{ -1649.77,151.1,62.16 },
		{ -1094.99,427.28,75.87 },
		{ -667.14,471.47,114.14 }
	},
	["PizzaThis"] = {
		{ -30.67,-346.94,46.52 },
		{ -197.36,-831.38,30.75 },
		{ -284.41,-600.6,33.55 },
		{ -287.26,-1060.19,27.2 },
		{ -170.71,-1449.71,31.64 },
		{ 87.57,-1670.53,29.18 },
		{ 218.1,-1838.83,27.33 },
		{ 379.52,-1781.49,29.47 },
		{ 561.39,-1751.82,29.28 },
		{ 431.69,-2035.13,23.32 },
		{ -421.75,-2171.55,11.34 },
		{ -621.03,-1639.95,26.35 },
		{ -697.59,-1182.27,10.72 },
		{ -1031.3,-902.98,3.69 },
		{ -1499.69,-933.09,10.18 },
		{ -1918.69,-542.63,11.83 },
		{ -1681.23,-290.87,51.88 },
		{ -1649.77,151.1,62.16 },
		{ -1094.99,427.28,75.87 },
		{ -667.14,471.47,114.14 }
	},
	["UwuCoffee"] = {
		{ -30.67,-346.94,46.52 },
		{ -197.36,-831.38,30.75 },
		{ -284.41,-600.6,33.55 },
		{ -287.26,-1060.19,27.2 },
		{ -170.71,-1449.71,31.64 },
		{ 87.57,-1670.53,29.18 },
		{ 218.1,-1838.83,27.33 },
		{ 379.52,-1781.49,29.47 },
		{ 561.39,-1751.82,29.28 },
		{ 431.69,-2035.13,23.32 },
		{ -421.75,-2171.55,11.34 },
		{ -621.03,-1639.95,26.35 },
		{ -697.59,-1182.27,10.72 },
		{ -1031.3,-902.98,3.69 },
		{ -1499.69,-933.09,10.18 },
		{ -1918.69,-542.63,11.83 },
		{ -1681.23,-290.87,51.88 },
		{ -1649.77,151.1,62.16 },
		{ -1094.99,427.28,75.87 },
		{ -667.14,471.47,114.14 }
	},
	["BeanMachine"] = {
		{ -30.67,-346.94,46.52 },
		{ -197.36,-831.38,30.75 },
		{ -284.41,-600.6,33.55 },
		{ -287.26,-1060.19,27.2 },
		{ -170.71,-1449.71,31.64 },
		{ 87.57,-1670.53,29.18 },
		{ 218.1,-1838.83,27.33 },
		{ 379.52,-1781.49,29.47 },
		{ 561.39,-1751.82,29.28 },
		{ 431.69,-2035.13,23.32 },
		{ -421.75,-2171.55,11.34 },
		{ -621.03,-1639.95,26.35 },
		{ -697.59,-1182.27,10.72 },
		{ -1031.3,-902.98,3.69 },
		{ -1499.69,-933.09,10.18 },
		{ -1918.69,-542.63,11.83 },
		{ -1681.23,-290.87,51.88 },
		{ -1649.77,151.1,62.16 },
		{ -1094.99,427.28,75.87 },
		{ -667.14,471.47,114.14 }
	},
	["Lumberman"] = {
		{ -513.92,-1019.31,23.47 },
		{ -1604.18,-832.26,10.08 },
		{ -536.48,-45.61,42.57 },
		{ -53.01,79.35,71.62 },
		{ 581.16,139.13,99.48 },
		{ 814.39,-93.48,80.6 },
		{ 1106.93,-355.03,67.01 },
		{ 1070.71,-780.46,58.36 },
		{ 1142.82,-986.58,45.91 },
		{ 1200.55,-1276.6,35.23 },
		{ 967.81,-1829.29,31.24 },
		{ 809.16,-2222.61,29.65 },
		{ 684.61,-2741.62,6.02 },
		{ 263.47,-2506.62,6.45 },
		{ 94.66,-2676.38,6.01 },
		{ -43.87,-2519.91,7.4 },
		{ 182.93,-2027.68,18.28 },
		{ -306.86,-2191.84,10.84 },
		{ -570.95,-1775.95,23.19 },
		{ -350.03,-1569.9,25.23 },
		{ -128.36,-1394.12,29.57 },
		{ 67.84,-1399.02,29.37 },
		{ 343.13,-1297.91,32.51 },
		{ 485.92,-1477.41,29.29 },
		{ 139.81,-1337.41,29.21 },
		{ 263.82,-1346.16,31.93 },
		{ -723.33,-1112.41,10.66 },
		{ -842.54,-1128.21,7.02 },
		{ 488.46,-898.56,25.94 }
	},
	["Drugsmansouth"] = {
		{ -1174.44,-1574.29,3.84 },
		{ -1039.19,-1396.77,5.54 },
		{ -845.96,-1089.03,11.63 },
		{ -603.2,-1018.2,22.33 },
		{ -327.2,-1300.33,31.34 },
		{ -144.58,-1429.58,30.89 },
		{ -26.13,-1532.72,30.48 },
		{ 182.43,-1836.8,28.11 },
		{ 246.53,-1996.32,20.15 },
		{ 467.24,-1901.39,25.33 },
		{ 464.52,-1672.44,29.28 },
		{ 489.05,-1499.65,29.22 },
		{ 846.97,-1315.87,26.44 },
		{ 909.95,-1025.74,38.15 },
		{ 806.21,-809.85,26.2 },
		{ 896.58,-144.1,76.82 },
		{ 583.6,137.41,99.46 },
		{ 214.84,-173.1,57.91 },
		{ -155.47,-7.95,58.22 },
		{ -535.85,-45.13,42.53 },
		{ -772.69,308.64,85.7 },
		{ -787.79,-170.04,37.29 },
		{ -992.38,-282.22,38.08 },
		{ -1200.63,-338.09,38.08 },
		{ -1291.29,-279.44,38.69 },
		{ -1671.36,-410.26,43.96 },
		{ -1552.95,-580.5,33.94 },
		{ -1354.41,-776.84,20.67 },
		{ -1328.94,-1150.18,4.38 }
	},
	["Drugsmannorth"] = {
		{ 2338.96,2569.4,47.72 },
		{ 2631.78,2935.81,40.42 },
		{ 2988.02,3482.35,72.49 },
		{ 2928.23,4474.42,48.0 },
		{ 2589.93,4678.96,34.07 },
		{ 2409.61,4295.71,35.13 },
		{ 2522.23,4111.72,38.62 },
		{ 2452.15,3756.94,41.87 },
		{ 1860.93,3865.47,33.06 },
		{ 1773.49,3742.25,34.66 },
		{ 915.49,3566.97,33.8 },
		{ 378.07,3583.61,33.3 },
		{ 33.42,3666.65,39.82 },
		{ 347.04,3406.28,36.48 },
		{ 179.23,3033.33,43.98 },
		{ -107.85,2795.16,53.3 },
		{ -262.37,2195.61,130.4 },
		{ -126.01,1894.86,197.33 },
		{ 165.93,2229.7,90.72 },
		{ 260.54,2581.32,44.99 },
		{ 356.91,2982.76,40.83 },
		{ 642.99,2791.76,41.97 },
		{ 728.85,2311.72,51.07 },
		{ 841.96,2112.64,52.27 },
		{ 1281.82,1887.21,83.51 },
		{ 1197.22,2643.28,37.83 },
		{ 1738.44,3029.75,63.15 },
		{ 2368.17,3156.31,48.21 },
		{ 2709.38,3454.16,56.14 },
		{ 2663.29,2892.14,36.85 }
	}
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- DELIVER:STARTING
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("deliver:Starting")
AddEventHandler("deliver:Starting",function(Init)
	if Cds[Init] then
		if Starting then
			Starting = false
			exports["target"]:LabelText("Deliver:"..Init,"Trabalhar")
			TriggerEvent("Notify","verde","Trabalho finalizado.",3000)
			TriggerEvent("Notify:Text","")
			-- TriggerEvent("Notify2","#workFinished")

			if DoesBlipExist(Blip) then
				RemoveBlip(Blip)
				Blip = nil
			end

			if Locate ~= Init then
				Selected = 1
			end
		else
			if initList[Init][7] then
				if Locate ~= Init then
					Selected = 1
				end
			else
				if Locate ~= Init then
					Selected = math.random(#Cds[Init])
				end
			end

			Locate = Init
			Starting = true
			TriggerEvent("Notify","verde","Trabalho iniciado.",3000)
			TriggerEvent("Notify:Text","F7 Para Cancelar Rotas")
			-- TriggerEvent("Notify2","#workStarted")
			exports["target"]:LabelText("Deliver:"..Init,"Finalizar")
			Marker(Cds[Locate][Selected][1],Cds[Locate][Selected][2],Cds[Locate][Selected][3])
            -- SetEntityCoords(PlayerPedId(),Cds[Locate][Selected][1],Cds[Locate][Selected][2],Cds[Locate][Selected][3]-1)

			while Starting do
				local TimeDistance = 999
				local Ped = PlayerPedId()
				if not IsPedInAnyVehicle(Ped) then
					local Coords = GetEntityCoords(Ped)
					local Vector = vec3(Cds[Locate][Selected][1],Cds[Locate][Selected][2],Cds[Locate][Selected][3])
					local Distance = #(Coords - Vector)

					if Distance <= 15.0 then
						TimeDistance = 1

						if Distance <= 1.0 then
							DrawTextDeliver(Vector["x"],Vector["y"],Vector["z"],"E N T R E G A R",true)
						else
							DrawTextDeliver(Vector["x"],Vector["y"],Vector["z"],"E N T R E G A R",false)
						end
					end
				end

				Wait(TimeDistance)
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- DELIVER
-----------------------------------------------------------------------------------------------------------------------------------------
function Creative.Deliver(Service)
	if Starting and Service == Locate then
		local Ped = PlayerPedId()
		local Coords = GetEntityCoords(Ped)
		local Vector = vec3(Cds[Locate][Selected][1],Cds[Locate][Selected][2],Cds[Locate][Selected][3])
		local Distance = #(Coords - Vector)

		if Distance <= 1.0 then
			return true
		end
	end

	return false
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- UPDATE
-----------------------------------------------------------------------------------------------------------------------------------------
function Creative.Update()
	if initList[Locate][7] then
		if Selected >= #Cds[Locate] then
			Selected = 1
		else
			Selected = Selected + 1
		end
	else
		Selected = math.random(#Cds[Locate])
	end
    -- SetEntityCoords(PlayerPedId(),Cds[Locate][Selected][1],Cds[Locate][Selected][2],Cds[Locate][Selected][3]-1)
	Marker(Cds[Locate][Selected][1],Cds[Locate][Selected][2],Cds[Locate][Selected][3])
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- DrawTextDeliver
-----------------------------------------------------------------------------------------------------------------------------------------
function DrawTextDeliver(x,y,z,text,color)
	local onScreen,_x,_y = GetScreenCoordFromWorldCoord(x,y,z)

	if onScreen then
		BeginTextCommandDisplayText("STRING")
		AddTextComponentSubstringKeyboardDisplay(text)

		if color then
			SetTextColour(150,196,172,255)
		else
			SetTextColour(204,204,204,175)
		end

		SetTextScale(0.35,0.35)
		SetTextFont(4)
		SetTextCentre(1)
		EndTextCommandDisplayText(_x,_y)

		local width = string.len(text) / 300

		if color then
			DrawRect(_x,_y + 0.0125,width,0.03,162,124,219,200)
		else
			DrawRect(_x,_y + 0.0125,width,0.03,15,15,15,200)
		end
	end
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- MARKER
-----------------------------------------------------------------------------------------------------------------------------------------
function Marker(x,y,z)
	if DoesBlipExist(Blip) then
		RemoveBlip(Blip)
		Blip = nil
	end

	Blip = AddBlipForCoord(x,y,z)
	SetBlipSprite(Blip,1)
	SetBlipColour(Blip,2)
	SetBlipScale(Blip,0.5)
	SetBlipRoute(Blip,true)
	SetBlipAsShortRange(Blip,true)
	BeginTextCommandSetBlipName("STRING")
	AddTextComponentString("Entrega do "..Locate)
	EndTextCommandSetBlipName(Blip)
end

-- 0ff --
RegisterCommand("-delivercancel", function()
	if (Starting) then
		TriggerEvent("deliver:Starting", next(Cds))
	end
end)

RegisterKeyMapping("-delivercancel", "Cancelar as rotas de entrega.", "keyboard", "F7")